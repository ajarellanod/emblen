{% extends 'base/base.html' %}

{% load widget_tweaks %}

{% block menu %}
  {% include 'formulacion/menu.html' %}  
{% endblock menu %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="{% url 'formulacion:principal' %}"><i class="fas fa-home"></i></a></li>
{% endblock breadcrumb %}

{% block body %}
  <div class="card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col-8">
          <h3 class="mb-0">Creación Cuenta Presupuestaria</h3>
        </div>
        <div class="col-4 text-right">
          <a href="#!" class="btn btn-sm btn-primary">Guardar</a>
          <a href="#!" class="btn btn-sm btn-default">Cancelar</a>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form>
        <h6 class="heading-small text-muted mb-4">Crear Partida Presupuestaria</h6>
        <div class="pl-lg-4">
          <div class="row">
            <div class="col-lg-1">
                <div class="form-group">
                  <label class="form-control-label " for="input-username">Nivel 1</label>
                  {% render_field form.codigo_uno class="form-control selects_partidas" %}
                </div>
              </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 2</label>
                    <select class="form-control selects_partidas" id="id_codigo_dos">
                        <option class="form-control">-------</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 3</label>
                    <select class="form-control  selects_partidas" id="id_codigo_tres">
                        <option class="form-control">-------</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 4</label>
                    <select class="form-control selects_partidas" id="id_codigo_cuatro">
                        <option class="form-control">-------</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 5</label>
                    <select class="form-control selects_partidas" id="id_codigo_cinco">
                        <option class="form-control">-------</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 6</label>
                    <input type="text" id="input-country" class="form-control" maxlength="2" placeholder="Nivel 2">
                </div>
            </div>
            <div class="col-lg-1">
                <div class="form-group">
                    <label class="form-control-label" for="input-country">Nivel 7</label>
                    <input type="text" id="input-country" class="form-control" maxlength="3" placeholder="Nivel 3">
                </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label class="form-control-label" for="input-email">Cuenta Completa</label>
                {% render_field form.cuenta class="form-control" placeholder="Partida" %}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-1">
                <div class="form-group">
                  <label class="form-control-label" for="input-username">{{ form.nivel.label }}</label>
                  {% render_field form.nivel class="form-control form-control-alternative" %}
                </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label class="form-control-label" for="input-last-name">{{ form.saldo.label }}</label>
                {% render_field form.saldo class="form-control" placeholder="Saldo" %}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label class="form-control-label" for="input-first-name">{{ form.descripcion.label }}</label>
                {% render_field form.descripcion class="form-control" placeholder="Descripción de Partida" %}
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endblock body %}

{% block script %}
  <script>

    function updateSelect(data,id){
      // console.log(typeof data);
      // console.log("id:  "+id);
      Fdata=JSON.parse(data);
      let id_siguiente='';
      let inicio,fin;
      switch (id){
        case 'id_codigo_uno':
          id_siguiente='id_codigo_dos';
          inicio=1;
          fin=3;
          break;
        case 'id_codigo_dos':
          id_siguiente='id_codigo_tres';
          inicio=3;
          fin=5;              
          break;
        case 'id_codigo_tres':
          id_siguiente='id_codigo_cuatro';
          inicio=5;
          fin=7;              
          break;          
        case 'id_codigo_cuatro':
          id_siguiente='id_codigo_cinco';
          inicio=7;
          fin=9;              
          break;          
        default:
          id_siguiente='id_codigo_uno';
          inicio=1;
          fin=3;
      }

      function reset_Select(select){
        $('#'+select).empty();
        $('#'+select).html($('<option/>', {
          text: '------',
          value: '',
        }));
      }
      reset_Select(id_siguiente);
      if(id==='id_codigo_uno'){
        $('#id_codigo_uno option')[0].disabled = true;
      }
      if(id_siguiente==='id_codigo_dos'){
        reset_Select('id_codigo_dos');
        reset_Select('id_codigo_tres');
        reset_Select('id_codigo_cuatro');
        reset_Select('id_codigo_cinco');
      }


      
      
      $('#'+id_siguiente+' option')[0].disabled = true;

      Fdata.forEach(function(object){
        console.log(object);
        let $lider_list = $('#'+id_siguiente+' option');

        $('#'+id_siguiente).append($('<option />', {
          text: object['fields'].cuenta.slice(inicio,fin),
          value: object['pk'],
        }));

      });
        
    }

    function postQuery(url, data, callback=false,id){
        $.ajax({
          type: "POST",
          url: url,
          dataType: "json", 
          data: {
            data: data,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(data){
            if(callback){
                callback(data,id);
            }else{
                return data
            }
          },
          error: function(error){
            return error;
          }
      });
    }

    $(document).ready(function(){
      
      $('.selects_partidas').on('change', function() {
        let id=$(this).attr("id");

        if (id != 'id_codigo_cinco'){
          let pk = $("#"+id).val();
          data = postQuery("{% url 'formulacion:crear_partida' %}", pk, updateSelect,id);
        }

      });

        // $('#id_codigo_uno').on('change', function() {
        //     let pk = $("#id_codigo_uno").val();
        //     data = postQuery("{% url 'formulacion:crear_partida' %}", pk, updateSelect);
        // });

    });
  </script>
{% endblock script %}